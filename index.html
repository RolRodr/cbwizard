<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src  'self';
                   style-src   'self';
                   img-src     'self' https://avatars.githubusercontent.com;
                   connect-src 'self' https://api.github.com https://raw.githubusercontent.com;
                   font-src    'self';
                   object-src  'none';
                   base-uri    'self';
                   form-action 'self';">
    <title>CB Wizard</title>
    <meta name="description" content="A simple webapp that allows you to easily create your CollectionBuilder project!">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>

<body>
    <a href="#wizard-container" class="skip-link">Skip to main content</a>

    <header>
        <div id="header-content">
            <img src="assets/wizard.svg" alt="" width="32" height="32" style="display: inline-block; margin-left: 8px; vertical-align: middle;">
            <h1>CollectionBuilder Wizard</h1>
        </div>
        <div id="user-info" class="hidden">
            Logged in as <span id="username"></span>
            <button id="logout-btn">Logout</button>
            <span id="logout-confirm" class="logout-confirm hidden" role="alertdialog"
                aria-labelledby="logout-confirm-msg">
                <span id="logout-confirm-msg">Clear all local data and log out?</span>
                <button id="logout-yes-btn" class="secondary">Yes, log out</button>
                <button id="logout-no-btn" class="secondary">Cancel</button>
            </span>
        </div>
    </header>

    <div id="app-layout">

        <nav id="step-nav" class="hidden" aria-label="Wizard steps">
            <ol>
                <li data-step="1" id="nav-step-1">Connect</li>
                <li data-step="2" id="nav-step-2">Fork Template</li>
                <li data-step="3" id="nav-step-3">CSV Metadata</li>
                <li data-step="4" id="nav-step-4">Media Files</li>
                <li data-step="5" id="nav-step-5">Publish</li>
                <li data-step="6" id="nav-step-6">Published</li>
            </ol>
        </nav>

        <main id="wizard-container">
            <!-- Step 0: Welcome -->
            <section id="step-0" class="wizard-step active">
                <h2>Welcome to CollectionBuilder Wizard!</h2>
                <p>This tool allows you to quickly get started creating a <a href="https://collectionbuilder.github.io/" target="_blank"
                    rel="noopener noreferrer">CollectionBuilder</a> digital exhibit, created by the Center for Digital Inquiry and 
                    Learning at the University of Idaho. I created this tool in response to working with digital humanists who found 
                    CollectionBuilder appealing but still technically difficult. At this point, this tool is just fun project intended 
                    to get you started with CollectionBuilder. You should still familiarize yourself with the CollectionBuilder documentation 
                    (it's really well-detailed).</p>
                
                <p>You will need a GitHub account. <a href="https://github.com/signup" target="_blank">Click here to make one</a></p>
                <button id="start-btn" style="margin-top: 20px;">Get Started</button>
                <p style="margin-top: 16px; font-size: 0.9rem;"><a href="#" id="about-link-step0">About this Project</a></p>
            </section>

            <!-- Step 1: Connect -->
            <section id="step-1" class="wizard-step hidden">
                <h2>Connect to GitHub</h2>
                <p>Please enter your Personal Access Token (PAT). The token requires <code>repo</code> scope to fork and
                    write to repositories.</p>
                <form id="auth-form">
                    <details class="instructions">
                        <summary>How to create a Personal Access Token (Classic)</summary>
                        <div class="info-message">
                            ⚠️ <strong>Note:</strong> We recommend using a <strong>Classic Token</strong> because
                            Fine-grained tokens currently have API limitations when forking public repositories you
                            don't
                            own.
                        </div>
                        <ol>
                            <li>Go to <a href="https://github.com/settings/tokens" target="_blank"
                                    rel="noopener noreferrer">GitHub Settings &gt; Developer Settings &gt; Tokens
                                    (Classic)
                                    <span aria-hidden="true">↗</span><span class="sr-only"> (opens in a new
                                        tab)</span></a>.
                            </li>
                            <li>Click "Generate new token (classic)".</li>
                            <li>Give it a Note (e.g., "Wizard App").</li>
                            <li>Select the <code>repo</code> scope (Full control of private repositories).
                                <ul>
                                    <li>Required to fork the template and push content.</li>
                                </ul>
                            </li>
                            <li>Click "Generate token" and copy it here.</li>
                        </ol>
                    </details>
                    <label for="github-token">Personal Access Token:</label>
                    <input type="password" id="github-token" required autocomplete="current-password">
                    <div class="warning">
                        ⚠️ Tokens are stored in your browser's local storage. Ensure you are on a trusted device.
                        <a href="https://github.com/RolRodr/cbwizard/blob/main/PRIVACY.md" target="_blank">Click here to learn more about this app's privacy.</a>
                    </div>
                    <button type="submit" id="connect-btn">Connect</button>
                </form>

                <div id="user-confirmation" class="hidden">
                    <div class="user-profile-card">
                        <div class="user-profile-main">
                            <img id="user-avatar" src="" alt="" width="80" height="80" class="user-profile-avatar">
                            <div class="user-profile-info">
                                <h3 id="confirm-displayname" class="user-profile-name"></h3>
                                <p id="confirm-username" class="user-profile-username"></p>
                                <p id="confirm-bio" class="user-profile-bio"></p>
                            </div>
                        </div>
                        <div class="user-profile-stats">
                            <div class="stat-item">
                                <span id="confirm-repos" class="stat-value">0</span>
                                <span class="stat-label">Repositories</span>
                            </div>
                        </div>
                    </div>
                    <div class="actions" style="margin-top: 16px;">
                        <button id="confirm-user-btn">Yes, Continue</button>
                        <button id="cancel-user-btn" class="secondary">No, Sign Out</button>
                    </div>
                </div>
            </section>

            <!-- Step 2: Fork -->
            <section id="step-2" class="wizard-step hidden">
                <h2>Step 2: Fork Template</h2>

                <div id="fork-options-container">
                    <p>We will fork the official <strong><a
                                href="https://github.com/CollectionBuilder/collectionbuilder-gh" target="_blank"
                                rel="noopener noreferrer">CollectionBuilder-GH <span aria-hidden="true">↗</span><span
                                    class="sr-only"> (opens in a new
                                    tab)</span></a></strong>
                        template to your account.</p>

                    <form id="fork-form">
                        <label for="template-repo">Template Repository (Source):</label>
                        <input type="text" id="template-repo" value="CollectionBuilder/collectionbuilder-gh" readonly
                            class="readonly-input">

                        <label for="new-repo-name" style="margin-top: 15px;">New Repository Name:</label>
                        <input type="text" id="new-repo-name" placeholder="my-collection-name" required
                            pattern="[a-zA-Z0-9\-\._]+" aria-describedby="repo-name-hint">
                        <p id="repo-name-hint" class="field-hint">Only letters, numbers, hyphens, periods, and
                            underscores
                            are
                            allowed.</p>
                        <div class="info-message">
                            ℹ️ This will be the name of your new repository on GitHub.
                        </div>
                        <button type="submit" id="fork-btn">Fork Repository</button>
                    </form>
                    <div id="fork-status" class="status-message hidden" role="status" aria-live="polite"></div>

                    <div style="margin-top: 24px; border-top: 1px solid var(--border-color); padding-top: 24px;">
                        <p>Already have a forked repository?</p>
                        <button id="show-existing-repos-btn" class="secondary">Select Existing Repository</button>
                    </div>
                </div>

                <!-- Existing Repos View -->
                <div id="existing-repos-container" class="hidden">
                    <button id="back-to-fork-btn" class="secondary" style="margin-bottom: 16px;">&larr; Back to
                        Fork</button>
                    <h3>Select Your Collection Repository</h3>
                    <p>Select a repository that was forked from <strong>CollectionBuilder-CSV</strong>.</p>

                    <input type="text" id="repos-search" placeholder="Search repositories..." aria-label="Filter repositories" style="margin-bottom: 12px;">

                    <div id="repos-loading" class="hidden">⏳ Loading your repositories...</div>
                    <div id="repos-error" class="error-message hidden"></div>

                    <div id="repos-list" class="repos-list"></div>
                </div>

                <div id="step-2-success" class="hidden" style="margin-top: 20px;" role="status">
                    <div class="success-message">
                        ✅ Repository selected <span id="selected-repo-name" style="font-weight:bold;"></span>! <br>
                        <a id="new-repo-link" href="#" target="_blank" rel="noopener noreferrer">View on GitHub <span
                                aria-hidden="true">↗</span><span class="sr-only"> (opens in a new tab)</span></a>
                    </div>
                    <!-- File Tree Visualization -->
                    <div id="repo-file-tree-container" class="file-tree-container hidden">
                        <h4>Repository Contents:</h4>
                        <pre id="repo-file-tree" class="file-tree-code"></pre>
                    </div>
                    <button id="step-2-next" style="margin-top: 10px;">Next: CSV Metadata</button>
                </div>
            </section>

            <!-- Step 3: CSV Metadata -->
            <section id="step-3" class="wizard-step hidden">
                <h2>Step 3: CSV Metadata</h2>
                <p>Select a CSV metadata file for your collection. Make sure your CSV follows the required
                    format —
                    refer to the <a href="https://collectionbuilder.github.io/cb-docs/docs/metadata/gh_metadata/"
                        target="_blank" rel="noopener noreferrer">CollectionBuilder Metadata Documentation <span
                            aria-hidden="true">↗</span><span class="sr-only"> (opens in a new tab)</span></a> for
                    guidance
                    on required fields and formatting.</p>

                <!-- Demo metadata from the forked repo -->
                <div id="demo-csv-section">
                    <h3>Template Demo Data <span class="field-hint" style="font-weight:400;">(from your forked
                            repository)</span></h3>
                    <div id="demo-csv-loading" class="info-message">⏳ Loading demo metadata from your repository…</div>
                    <div id="demo-csv-error" class="hidden" style="font-size:13px; color:#57606a; margin-bottom:12px;">
                    </div>
                    <div id="demo-csv-table-wrap" class="demo-table-wrap hidden">
                        <table id="demo-csv-table" class="demo-table"></table>
                    </div>
                </div>

                <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-color);">

                <label for="csv-file">Select Your CSV Metadata File:</label>
                <p id="csv-file-hint" class="field-hint">Select a .csv file with your collection metadata. Need help? Check the <a href="https://collectionbuilder.github.io/cb-docs/docs/metadata/gh_metadata/" target="_blank" rel="noopener noreferrer">metadata documentation</a>.</p>
                <input type="file" id="csv-file" accept=".csv" aria-describedby="csv-file-hint">

                <!-- Table preview of uploaded CSV -->
                <div id="csv-preview" class="demo-table-wrap hidden" style="margin-top: 16px;">
                    <table id="csv-table" class="demo-table"></table>
                </div>

                <!-- Filename controls (shown after file selected) -->
                <div id="csv-upload-controls" class="hidden" style="margin-top: 20px;">
                    <label for="csv-filename">File name in repository:</label>
                    <div class="csv-name-row">
                        <span class="csv-name-prefix">_data/</span>
                        <input type="text" id="csv-filename" placeholder="my-collection"
                            aria-describedby="csv-filename-hint">
                        <span class="csv-name-suffix">.csv</span>
                    </div>
                    <p id="csv-filename-hint" class="field-hint">Only letters, numbers, hyphens, underscores, and
                        periods.</p>
                    <div class="info-message">ℹ️ Your CSV will be uploaded when you publish in the final step.</div>
                    <button id="step-3-next" style="margin-top: 12px;">Next: Media Files</button>
                </div>
            </section>

            <!-- Step 4: Media Files -->
            <section id="step-4" class="wizard-step hidden">
                <h2>Step 4: Media Files (Optional)</h2>
                <p>Select media files for your collection (Images, Audio, PDF). Ideally, use URLs for large files in
                    your CSV because GitHub
                    has strict limits on file sizes. <strong>Files must not exceed 10 MB each.</strong></p>
                <label for="image-files">Select Media:</label>
                <p id="media-file-hint" class="field-hint">Accepted formats: JPEG, PNG, MP3, PDF. Each file must be under 10 MB.</p>
                <input type="file" id="image-files" accept="image/*,audio/*,application/pdf" multiple aria-describedby="media-file-hint">
                <div id="image-preview" class="preview-container hidden"></div>
                <div class="info-message" style="margin-top: 16px;">ℹ️ Media files will be uploaded when you publish in the final step.</div>
                <div id="step-4-buttons" style="margin-top: 16px;">
                    <button id="step-4-next">Next: Configure &amp; Publish</button>
                    <button id="step-4-skip" class="secondary">Skip Media</button>
                </div>
            </section>

            <!-- Step 5: Configure & Publish -->
            <section id="step-5" class="wizard-step hidden">
                <h2>Step 5: Configure &amp; Publish</h2>

                <div id="config-section" style="margin-bottom: 24px;">
                    <p>Configure your site settings below, then publish everything to GitHub. This will upload your CSV, media files, update your site configuration, and enable GitHub Pages — all at once.</p>

                    <label for="config-title">Site Title:</label>
                    <input type="text" id="config-title" placeholder="My Digital Collection" aria-describedby="config-title-hint">
                    <p id="config-title-hint" class="field-hint">The name displayed in the header of your site.</p>

                    <label for="config-tagline">Tagline (optional):</label>
                    <input type="text" id="config-tagline" placeholder="A short description of your collection" aria-describedby="config-tagline-hint">
                    <p id="config-tagline-hint" class="field-hint">A subtitle shown below the title.</p>

                    <label for="config-description">Description (optional):</label>
                    <input type="text" id="config-description" placeholder="Brief description for search engines and social sharing" aria-describedby="config-desc-hint">
                    <p id="config-desc-hint" class="field-hint">Used for SEO meta tags.</p>

                    <label for="config-metadata">Metadata Filename:</label>
                    <input type="text" id="config-metadata" readonly class="readonly-input" aria-describedby="config-metadata-hint">
                    <p id="config-metadata-hint" class="field-hint">Auto-populated from your CSV filename.</p>

                    <div id="featured-image-section" style="margin-top: 20px;">
                        <label for="config-featured-image">Featured Image (optional):</label>
                        <p id="config-featured-hint" class="field-hint">Select an item from your collection to use as the homepage banner image. This sets <code>featured-image</code> in <code>_data/theme.yml</code>.</p>
                        <div class="featured-image-picker">
                            <select id="config-featured-image" aria-describedby="config-featured-hint">
                                <option value="">— None (use default) —</option>
                            </select>
                            <div id="featured-image-preview" class="featured-image-preview hidden"></div>
                        </div>
                    </div>
                </div>

                <!-- Upload summary -->
                <div id="publish-summary" class="info-message" style="margin-bottom: 16px;">
                    <strong>Ready to publish:</strong>
                    <ul id="publish-summary-list" style="margin: 8px 0 0 16px; padding: 0;"></ul>
                </div>

                <div id="publish-progress" class="upload-progress-container hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Publish progress">
                    <div class="upload-progress-label" id="publish-progress-label">Publishing...</div>
                    <div class="upload-progress-bar">
                        <div class="upload-progress-fill" id="publish-progress-fill"></div>
                    </div>
                </div>
                <button id="publish-btn">Publish to GitHub</button>
            </section>

            <!-- Step 6: Start Over / Success -->
            <section id="step-6" class="wizard-step hidden">
                <h2>Published!</h2>
                <p>Your content has been successfully uploaded.</p>
                <div id="publish-links"></div>
                <button id="reset-app-btn">Start Over</button>
            </section>
        </main>

    </div><!-- /#app-layout -->

    <div id="global-error" class="error-message hidden" role="alert" aria-live="assertive"></div>
    <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

    <footer id="main-footer">
        <div class="footer-content">
            <div class="footer-left">
                <p>Created by <a href="https://guides.lib.unc.edu/rolandorodriguez" target="_blank">Rolando Rodriguez</a></p>
                <p>Icons by <a href="https://thenounproject.com" target="_blank">Noun Project</a></p>
            </div>
            <div class="footer-right">
                <a href="https://github.com/RolRodr/cbwizard" target="_blank" rel="noopener noreferrer">GitHub</a> | <a
                    href="https://collectionbuilder.github.io/" target="_blank" rel="noopener noreferrer">About this
                    project</a>
            </div>
        </div>
    </footer>

    <script type="module" src="js/main.js"></script>
</body>

</html>